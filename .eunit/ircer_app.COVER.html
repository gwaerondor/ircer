<html>
<head><title>.eunit/ircer_app.COVER.html</title></head><body bgcolor=white text=black>
<pre>
File generated from /home/erolars/erlangassignments/ircer/.eunit/ircer_app.erl by COVER 2014-07-17 at 13:18:28

****************************************************************************

        |  -module(ircer_app).
        |  -behaviour(application).
        |  -include("irc.hrl").
        |  
        |  %% Application callbacks
        |  -export([
        |  	 start/2,
        |  	 start/4,
        |  	 start/0,
        |  	 stop/1,
        |  	 handle_messages/1
        |  	]).
        |  
        |  -define(print_warning(Msg), printer:print_warning_message(Msg)).
        |  -define(print_err(Msg), printer:print_error_message(Msg)).
        |  -define(print_inc(Msg), printer:print_incoming_server_message(Msg)).
        |  -define(print_out(Msg), printer:print_outgoing_server_message(Msg)).
        |  -define(print_msg(Msg), printer:print_regular_message(Msg)).
        |  -define(log(Msg), logger:write("ircer_app", Msg)).
        |  -define(GET_SOCKET,
        |  	fun(#connection_data{socket=Sock}) -&gt; Sock end).
        |  -define(SET_SOCKET, fun(Sock, Connection_data) -&gt;
        |          Connection_data#connection_data{socket=Sock} end).
        |  -define(GET_SERVER_AND_PORT,
        |  	fun(#connection_data{server=Server, port=Port}) -&gt; [Server, Port] end).
        |  -define(IGNORE_RESULTS,
        |  	fun(_, Connection_data) -&gt; Connection_data end).
        |  -define(GET_NICK_AND_REALNAME,
        |  	fun(#connection_data{nick=Nickname, realname=Realname}) -&gt;
        |  	[Nickname, Realname] end).
        |  -define(GET_REALNAME,
        |  	fun(#connection_data{realname=Realname}) -&gt;
        |  	Realname end).
        |  -define(GET_NICK,
        |  	fun(#connection_data{nick=Nickname}) -&gt;
        |  	Nickname end).
        |  -define(NOTHING,
        |  	fun(#connection_data{}) -&gt;
        |  	nothing end).
        |  
        |  %% ===================================================================
        |  %% Application callbacks
        |  %% ===================================================================
        |  
        |  start(_, Start_args) -&gt;
<font color=red>     0..|      ?log("=== Starting IRCER client ==="),</font>
<font color=red>     0..|      [Server, Port, Nickname, Realname] = Start_args,</font>
<font color=red>     0..|      connect(Server, Port, Nickname, Realname),</font>
<font color=red>     0..|      {ok, self()}.</font>
        |  
        |  start(Server, Port, Nickname, Realname) -&gt;
<font color=red>     0..|      Start_args = [Server, Port, Nickname, Realname],</font>
<font color=red>     0..|      start(undefined, Start_args).</font>
        |  
        |  start() -&gt;
<font color=red>     0..|      Start_args = ["port80b.se.quakenet.org", 6667, "Gwaeron", "Robin Larsson"],</font>
<font color=red>     0..|      start(undefined, Start_args).</font>
        |  
        |  stop(_State) -&gt;
<font color=red>     0..|      ok.</font>
        |  
        |  %% ===================================================================
        |  %% Functions
        |  %% ===================================================================
        |  
        |  connect(Server, Port, Nickname, Realname) -&gt;
<font color=red>     0..|      Connection_data = #connection_data{server = Server, </font>
        |  				       port = Port,
        |  				       nick = Nickname, 
        |  				       realname = Realname
        |  				      },
<font color=red>     0..|      ?log("Trying to connect to "++ Server ++ " as " ++ Nickname),</font>
<font color=red>     0..|      connect_sequence([</font>
        |  		      open_connection(),
        |  		      start_socket_handler(),
        |  		      request_nick(),
        |  		      send_ident()
        |  		     ], Connection_data),
<font color=red>     0..|      ok.</font>
        |  
        |  connect_sequence([], _Connection_data)-&gt;
<font color=red>     0..|      ok;</font>
        |  connect_sequence([{F, Get, Set} | T], Connection_data)-&gt;
<font color=red>     0..|      connect_sequence(T, Set(F(Get(Connection_data)), Connection_data)).</font>
        |  
        |  open_connection() -&gt;
<font color=red>     0..|      {fun open_connection/1,</font>
<font color=red>     0..|       ?GET_SERVER_AND_PORT,</font>
<font color=red>     0..|       ?SET_SOCKET</font>
        |      }.
        |  
        |  open_connection([Server, Port]) -&gt;
<font color=red>     0..|      open_connection(Server, Port).</font>
        |  
        |  open_connection(Server, Port) -&gt;
<font color=red>     0..|      case gen_tcp:connect(Server,Port,[{active, false}]) of</font>
        |  	{ok, Sock} -&gt;
<font color=red>     0..|  	    ?log("Connected. Now logging in."),</font>
<font color=red>     0..|  	    Sock;</font>
        |  	Err -&gt;
<font color=red>     0..|  	    ?log("Could not connect to server " ++ Server ++ ":" ++ integer_to_list(Port)),</font>
<font color=red>     0..|  	    Err</font>
        |      end.
        |  
        |  request_nick() -&gt;
<font color=red>     0..|      {fun request_nick/1,</font>
<font color=red>     0..|       ?GET_NICK,</font>
<font color=red>     0..|       ?IGNORE_RESULTS</font>
        |      }.
        |  
        |  request_nick(Nickname) -&gt;
<font color=red>     0..|      i:nick(Nickname).</font>
        |  
        |  send_ident() -&gt;
<font color=red>     0..|      {fun send_ident/1,</font>
<font color=red>     0..|       ?GET_NICK_AND_REALNAME,</font>
<font color=red>     0..|       ?IGNORE_RESULTS</font>
        |      }.
        |  
        |  start_socket_handler(Sock) -&gt;
<font color=red>     0..|      socket_handler:start(Sock).</font>
        |  
        |  start_socket_handler() -&gt;
<font color=red>     0..|      { fun start_socket_handler/1,</font>
<font color=red>     0..|        ?GET_SOCKET,</font>
<font color=red>     0..|        ?IGNORE_RESULTS</font>
        |      }.
        |  
        |  send_ident([Nickname, Realname]) -&gt;
<font color=red>     0..|      i:send_ident(Nickname, Realname).</font>
        |  
        |  handle_messages([Message|More_messages]) -&gt;
<font color=red>     0..|      Decoded_message = codec:decode_message(Message),</font>
<font color=red>     0..|      case Decoded_message#message.type of</font>
        |  	ping -&gt;
<font color=red>     0..|  	    ?log("Ping " ++ Decoded_message#message.text),</font>
<font color=red>     0..|  	    pong(Decoded_message#message.text);</font>
        |  	_ -&gt;
<font color=red>     0..|  	    ?print_inc(codec:make_printable(Decoded_message))</font>
        |      end,
<font color=red>     0..|      handle_messages(More_messages);</font>
        |  handle_messages([]) -&gt;
<font color=red>     0..|      ok.</font>
        |  
        |  pong(Number) -&gt;
<font color=red>     0..|      Outgoing = #message{type=pong, text=Number},</font>
<font color=red>     0..|      Outgoing_enc = codec:encode_message(Outgoing),</font>
<font color=red>     0..|      socket_handler ! {message, Outgoing_enc},</font>
<font color=red>     0..|      ?log("Pong " ++ Number).</font>
        |  
</pre>
</body>
</html>
