<html>
<head><title>.eunit/codec.COVER.html</title></head><body bgcolor=white text=black>
<pre>
File generated from /home/erolars/erlangassignments/ircer/.eunit/codec.erl by COVER 2014-07-17 at 13:18:28

****************************************************************************

        |  -module(codec).
        |  -include("irc.hrl").
        |  -export([
        |  	 decode_message/1,
        |  	 parse_lines/1,
        |  	 get_parameters/1,
        |  	 get_command/1,
        |  	 get_space_separated_tokens/2,
        |  	 make_printable/1,
        |  	 remove_leading_colon/1,
        |  	 with_leading_pound/1,
        |  	 text_before_bang/1,
        |  	 encode_message/1
        |  	]).
        |  -define(log(Msg), logger:write("codec", Msg)).
        |  
        |  parse_lines(Message) -&gt;
        |      % Since rstr() gives the index to where the
        |      % separator STARTS, we'll compensate for that
        |      % by adding 1 (to end at \r) or 2 (to start at \n)
     1..|      Separator = "\r\n",
     1..|      Last_separator_start_index = string:rstr(Message, Separator),
     1..|      Index_of_first_char_after_separator = Last_separator_start_index + 2,
     1..|      Last_separator_end_index = Last_separator_start_index + 1,
     1..|      Rest = string:substr(Message, Index_of_first_char_after_separator),
     1..|      First_char_index = 1,
     1..|      Full_lines = string:substr(Message,First_char_index, Last_separator_end_index),
     1..|      {string:tokens(Full_lines, "\r\n"), Rest}.
        |  
        |  decode_message(Encoded_message) -&gt;
    22..|      case get_command(Encoded_message) of
        |  	"PING :" -&gt;
     2..|  	    Ping_message = get_parameters(Encoded_message),
     2..|  	    #message{type=ping, text=Ping_message};
        |  	"NOTICE AUTH :" -&gt;
     1..|  	    NA_message = remove_leading_colon(get_parameters(Encoded_message)),
     1..|  	    #message{type=notice_auth, text=NA_message};
        |  	":" -&gt;
    18..|  	    decode_server_message(get_parameters(Encoded_message));
        |  	_ -&gt;
     1..|  	    #message{type=unsupported, text=Encoded_message}
        |      end.
        |  
        |  get_command(Message) -&gt;
    23..|      Index_of_separator = string:chr(Message, $:),
    23..|      string:substr(Message, 1, Index_of_separator).
        |  
        |  get_parameters(Message) -&gt;
    22..|      Index_of_separator = string:chr(Message, $:) + 1,
    22..|      string:substr(Message, Index_of_separator).
        |  
        |  decode_server_message(Server_message) -&gt;
        |  
    18..|      [_Sender, Code, _Remainder] = get_space_separated_tokens(Server_message, 2),
    18..|      case Code of
        |  	"JOIN" -&gt;
     1..|  	    decode_join_message(Server_message);
        |  	"MODE" -&gt;
     1..|  	    decode_mode_message(Server_message);
        |  	"NOTICE" -&gt;
     1..|  	    decode_notice_message(Server_message);
        |  	"PRIVMSG" -&gt;
     2..|  	    decode_private_message(Server_message);
        |  	"QUIT" -&gt;
     1..|  	    decode_quit_message(Server_message);
        |  	"KICK" -&gt;
     1..|  	    decode_kick_message(Server_message);
        |  	"PART" -&gt;
     2..|  	    decode_part_message(Server_message);
        |  	"NICK" -&gt;
     1..|  	    decode_nick_message(Server_message);
        |  	"332" -&gt;
     1..|  	    decode_topic_message(Server_message);
        |  	"366" -&gt;
     1..|  	    decode_end_of_name_list_message(Server_message);
        |  	"353" -&gt;
     1..|  	    decode_name_list_message(Server_message);
        |  	"372" -&gt;
     1..|  	    decode_motd(Server_message);
        |  	"404" -&gt;
     2..|  	    decode_cannot_send_to_channel(Server_message);
        |  	"433" -&gt;
     1..|  	    decode_nick_in_use_message(Server_message);
        |  	_ -&gt;
     1..|  	    #message{type=unsupported, text=Server_message}
        |      end.
        |  
        |  decode_cannot_send_to_channel(Message) -&gt;
     2..|      [_, _, _, Channel, CSTCMessage] = get_space_separated_tokens(Message, 4),
     2..|      Text = remove_leading_colon(CSTCMessage) ++ " " ++ Channel,
     2..|      #message{type = other,
        |  	     text = Text}.
        |  
        |  decode_private_message(Message) -&gt;
     2..|      [Sender, _, Target, Chat_msg] = get_space_separated_tokens(Message, 3),
     2..|      #message{type = privmsg,
        |  	     sender = remove_leading_colon(Sender),
        |  	     receiver = Target,
        |  	     text = remove_leading_colon(Chat_msg)
        |  	    }.
        |  
        |  decode_nick_message(Message) -&gt;
     1..|      [Sender, _, New_nick] = get_space_separated_tokens(Message, 2),
     1..|      #message{type = nick,
        |  	     sender = remove_leading_colon(Sender),
        |  	     text = remove_leading_colon(New_nick)
        |  	    }.
        |  
        |  decode_nick_in_use_message(Message) -&gt;
     1..|      [Sender, _, Old_nick, Attempted_nick, Error_message] = get_space_separated_tokens(Message, 4),
     1..|      ?log("Could not change nickname, " ++ Attempted_nick ++ " already in use."),
     1..|      #message{type = nick_in_use,
        |  	     sender = remove_leading_colon(Sender),
        |  	     receiver = Old_nick,
        |  	     text = remove_leading_colon(Error_message)
        |  	    }.
        |  
        |  decode_part_message(Message) -&gt;
     2..|      [Sender, _, Channel] = get_space_separated_tokens(Message, 2),
     2..|      #message{type = part,
        |  	     channel = Channel,
        |  	     sender = Sender
        |  	    }.
        |  
        |  decode_kick_message(Message) -&gt;
     1..|      [Sender, _Code, Channel, Receiver, Kick_message] = get_space_separated_tokens(Message, 4),
     1..|      #message{type = kick,
        |  	     channel = Channel,
        |  	     receiver = Receiver,
        |  	     sender = remove_leading_colon(Sender),
        |  	     text = remove_leading_colon(Kick_message)
        |  	    }.
        |  
        |  decode_quit_message(Message) -&gt;	     
     1..|      [Sender, _, Quit_msg] = get_space_separated_tokens(Message,2),
     1..|      #message{type = quit,
        |  	     sender = remove_leading_colon(Sender),
        |  	     text = remove_leading_colon(Quit_msg)
        |  	    }.
        |  
        |  decode_motd(Message) -&gt;
     1..|      [Sender, _, Nick, MOTD] = get_space_separated_tokens(Message,3),
     1..|      #message{type=motd,
        |  	     sender=remove_leading_colon(Sender),
        |  	     receiver=Nick,
        |  	     text=remove_leading_colon(MOTD)
        |  	    }.
        |  
        |  decode_name_list_message(Message) -&gt;
     1..|      [Sender, _, Nick, _, Channel, List] = get_space_separated_tokens(Message,5),
     1..|      #message{type=namelist,
        |  	     sender=remove_leading_colon(Sender),
        |  	     receiver=Nick,
        |  	     channel=Channel,
        |  	     text=remove_leading_colon(List)
        |  	    }.
        |  
        |  decode_end_of_name_list_message(Message) -&gt;
     1..|      [Sender, _, Nick, Channel, End_message] = get_space_separated_tokens(Message,4),
     1..|      #message{type=end_of_namelist,
        |  	     sender=remove_leading_colon(Sender),
        |  	     receiver=Nick,
        |  	     channel=Channel,
        |  	     text=remove_leading_colon(End_message)
        |  	    }.
        |  
        |  decode_topic_message(Message) -&gt;
     1..|      [Sender, _, Nick, Channel, Topic] = get_space_separated_tokens(Message, 4),
     1..|      #message{type=topic,
        |  	     sender=remove_leading_colon(Sender),
        |  	     receiver=Nick,
        |  	     channel=Channel,
        |  	     text=remove_leading_colon(Topic)
        |  	    }.
        |  
        |  decode_join_message(Message) -&gt;
     1..|      [Sender, _, Channel] = get_space_separated_tokens(Message, 2),
     1..|      #message{type=join,
        |  	     sender=remove_leading_colon(Sender),
        |  	     channel=Channel
        |  	    }.
        |  
        |  decode_mode_message(Message) -&gt;
     1..|      [Sender, _, Nick, Mode] = get_space_separated_tokens(Message, 3),
     1..|      #message{type=mode,
        |  	     sender=remove_leading_colon(Sender),
        |  	     receiver=Nick,
        |  	     text=Mode
        |  	    }.
        |  
        |  decode_notice_message(Message) -&gt;
     1..|      [Sender, _, Nick, Notice] = get_space_separated_tokens(Message, 3),
     1..|      #message{type=notice,
        |  	     sender=remove_leading_colon(Sender),
        |  	     receiver=Nick,
        |  	     text=remove_leading_colon(Notice)
        |  	    }.
        |  
        |  remove_leading_colon(Text) -&gt;
    31..|      case string:chr(Text, $:) of
        |  	1 -&gt;
    16..|  	    string:substr(Text, 2);
        |  	_ -&gt;
    15..|  	    Text
        |      end.
        |  
        |  text_before_bang(Text) -&gt;
    11..|      Index_before_bang = string:chr(Text, $!)-1,
    11..|      case (Index_before_bang &gt; 0) of
        |  	true -&gt;
     9..|  	    string:substr(Text,1,Index_before_bang);
        |  	_ -&gt;
     2..|  	    Text
        |      end.
        |  
        |  make_printable(Decoded_message) -&gt;
    13..|      Type = Decoded_message#message.type,
    13..|      case Type of
        |  	ping -&gt;
     1..|  	    "Ping?";
        |  	join -&gt;
     1..|  	    Channel = Decoded_message#message.channel,
     1..|  	    Nick = text_before_bang(Decoded_message#message.sender),
     1..|  	    Nick ++ " has joined " ++ Channel;
        |  	mode -&gt;
     1..|  	    Sender = text_before_bang(Decoded_message#message.sender),
     1..|  	    Target = Decoded_message#message.receiver,
     1..|  	    Mode = Decoded_message#message.text,
     1..|  	    Sender ++ " sets mode " ++ Mode ++ " to " ++ Target;
        |  	kick -&gt;
     1..|  	    Sender = text_before_bang(Decoded_message#message.sender),
     1..|  	    Target = Decoded_message#message.receiver,
     1..|  	    Kick_msg = Decoded_message#message.text,
     1..|  	    Channel = Decoded_message#message.channel,
     1..|  	    Sender ++ " has kicked " ++ Target ++ " from " ++ Channel ++ " (" ++ Kick_msg  ++ ")";
        |  	privmsg -&gt;
     3..|  	    Receiver = Decoded_message#message.receiver,
     3..|  	    Sender = text_before_bang(Decoded_message#message.sender),
     3..|  	    Message = Decoded_message#message.text,
     3..|  	    case string:chr(Receiver, $#) of
        |  		1 -&gt;
     2..|  		    Channel = Decoded_message#message.receiver,
     2..|  		    ?TIMESTAMP ++ " "++Channel++" ("++Sender++") " ++Message;
        |  		_ -&gt;
     1..|  		    ?TIMESTAMP ++ " -"++Sender++"- " ++Message
        |  	    end;
        |  	quit -&gt;
     1..|  	    Sender = text_before_bang(Decoded_message#message.sender),
     1..|  	    Sender ++ " has quit IRC (" ++ Decoded_message#message.text ++ ")";
        |  	part -&gt;
     1..|  	    Sender = text_before_bang(Decoded_message#message.sender),
     1..|  	    Channel = Decoded_message#message.channel,
     1..|  	    Sender ++ " has left " ++ Channel;
        |  	nick -&gt;
     1..|  	    Old_nick = text_before_bang(Decoded_message#message.sender),
     1..|  	    New_nick = Decoded_message#message.text,
     1..|  	    Old_nick ++ " is now called " ++ New_nick ++ ".";
        |  	unsupported -&gt;
     1..|  	    "? " ++ Decoded_message#message.text;
        |  	_ -&gt;
     2..|  	    Decoded_message#message.text
        |      end.
        |  
        |  get_space_separated_tokens(String, Number_of_splits) -&gt;
    36..|      get_space_separated_tokens(String, Number_of_splits, []).
        |  get_space_separated_tokens(String, 0, Acc) -&gt;
    36..|      Acc ++ [String];
        |  get_space_separated_tokens(String, Number_of_splits, Acc) -&gt;
    93..|      Index_of_first_space = string:chr(String, $\s),
    93..|      Index_of_last_char_before_first_space = Index_of_first_space-1,
    93..|      Index_of_first_char_after_first_space = Index_of_first_space+1,
    93..|      Index_of_first_letter = 1,
    93..|      Token = string:substr(String,
        |  			  Index_of_first_letter,
        |  			  Index_of_last_char_before_first_space
        |  			 ),
    93..|      Remainder = string:substr(String, Index_of_first_char_after_first_space),
    93..|      get_space_separated_tokens(Remainder, Number_of_splits - 1, Acc ++ [Token]).
        |  
        |  encode_message(Message) -&gt;
     9..|      Type = Message#message.type,
     9..|      case Type of
        |  	privmsg -&gt;
     1..|  	    encode_standard_message(Message#message.receiver, Message#message.text);
        |  	join -&gt;
     2..|  	    encode_join_message(Message#message.channel);
        |  	pong -&gt;
     2..|  	    encode_pong_message(Message#message.text);
        |  	ident -&gt;
     1..|  	    Nick = Message#message.sender,
     1..|  	    Realname = Message#message.text,
     1..|  	    encode_ident_message(Nick, Realname);
        |  	nick -&gt;
     1..|  	    encode_nick_message(Message#message.text);
        |  	part -&gt;
     1..|  	    Channel = Message#message.channel,
     1..|  	    Part_msg = Message#message.text,
     1..|  	    encode_part_message(Channel, Part_msg);
        |  	quit -&gt;
     1..|  	    encode_quit_message(Message#message.text)		
        |      end.
        |  
        |  encode_nick_message(Nickname) -&gt;
     1..|      "NICK :"++Nickname.
        |  
        |  encode_part_message(Channel, Message) -&gt;
     1..|      "PART " ++ with_leading_pound(Channel) ++ " :" ++ Message.
        |  
        |  encode_quit_message(Message) -&gt;
     1..|      "QUIT :" ++ Message.
        |  
        |  encode_standard_message(Receiver, Message) -&gt;
     1..|      "PRIVMSG " ++ Receiver ++ " :" ++ Message.
        |  
        |  encode_ident_message(Nickname, Realname) -&gt;
     1..|      "USER " ++ Nickname ++ " " ++ Nickname ++ " " ++ Nickname ++ " :" ++ Realname.
        |  
        |  encode_pong_message(Number) -&gt;
     2..|      "PONG :" ++ Number.
        |  
        |  encode_join_message(Channel) -&gt;
     2..|      "JOIN :" ++ with_leading_pound(Channel).
        |  
        |  with_leading_pound(Text) -&gt;
     5..|      case string:chr(Text, $#) of
        |  	1 -&gt;
     3..|  	    Text;
        |  	_ -&gt;
     2..|  	    "#" ++ Text
        |      end.
</pre>
</body>
</html>
