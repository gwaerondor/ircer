<html>
<head><title>.eunit/socket_handler.COVER.html</title></head><body bgcolor=white text=black>
<pre>
File generated from /home/erolars/erlangassignments/ircer/.eunit/socket_handler.erl by COVER 2014-07-17 at 13:18:28

****************************************************************************

        |  -module(socket_handler).
        |  -include("irc.hrl").
        |  -export([
        |  	 start/1,
        |  	 receive_messages/1
        |  	]).
        |  -define(print_warning(Msg), printer:print_warning_message(Msg)).
        |  -define(print_err(Msg), printer:print_error_message(Msg)).
        |  -define(print_inc(Msg), printer:print_incoming_server_message(Msg)).
        |  -define(print_out(Msg), printer:print_outgoing_server_message(Msg)).
        |  -define(print_msg(Msg), printer:print_regular_message(Msg)).
        |  -define(log(Msg), logger:write("socket_handler", Msg)).
        |  
        |  start(Sock) -&gt;
<font color=red>     0..|      spawn(fun() -&gt;</font>
<font color=red>     0..|  		  register(?MODULE, self()),</font>
<font color=red>     0..|  		  handle_messages_until_exit(Sock) end</font>
        |  	 ),
<font color=red>     0..|      spawn(?MODULE, receive_messages, [Sock]).</font>
        |  
        |  receive_messages(Sock) -&gt;
<font color=red>     0..|      case gen_tcp:recv(Sock, 0) of</font>
        |  	{ok, Msg} -&gt;	
<font color=red>     0..|  	    ?MODULE ! {tcp, Sock, Msg},</font>
<font color=red>     0..|  	    receive_messages(Sock);</font>
        |  	{error, closed} -&gt;
<font color=red>     0..|  	    ?log("Connection has been closed."),</font>
<font color=red>     0..|  	    ?log("Could not receive messages, socket has been closed."),</font>
<font color=red>     0..|  	    ok;</font>
        |  	Error -&gt;
<font color=red>     0..|  	    ErrorStr = io_lib:format("~p",[Error]),</font>
<font color=red>     0..|  	    ?MODULE ! quit,</font>
<font color=red>     0..|  	    ?log("Error in message receiver: " ++ ErrorStr),</font>
<font color=red>     0..|  	    ?log("Message receiver is shutting down. Your connection has been closed."),</font>
<font color=red>     0..|  	    ?print_err("Error in message receiver: " ++ ErrorStr),</font>
<font color=red>     0..|  	    ?print_err("Message receiver is shutting down. Your connection has been closed.")</font>
        |      end.
        |  
        |  handle_messages_until_exit(Sock) -&gt;
<font color=red>     0..|      handle_messages_until_exit(Sock, "").</font>
        |  
        |  handle_messages_until_exit(Sock, Message_rest) -&gt;
<font color=red>     0..|      receive</font>
        |  	{message, Outgoing_message} -&gt;
<font color=red>     0..|  	    send_to_server(Sock, Outgoing_message),</font>
<font color=red>     0..|  	    handle_messages_until_exit(Sock, Message_rest);</font>
        |  	{tcp, Sock, Incoming_msg} -&gt;
<font color=red>     0..|  	    {Msgs, Unfinished_msg} = codec:parse_lines(Message_rest ++ Incoming_msg),</font>
<font color=red>     0..|  	    ircer_app:handle_messages(Msgs),</font>
<font color=red>     0..|  	    handle_messages_until_exit(Sock, Unfinished_msg);</font>
        |  	quit -&gt;
<font color=red>     0..|  	    gen_tcp:shutdown(Sock, read_write),</font>
<font color=red>     0..|  	    ?print_warning("Connection has been closed.")</font>
        |      end.
        |  
        |  send_to_server(Sock, Message) -&gt;
<font color=red>     0..|      case gen_tcp:send(Sock, Message ++ "\r\n") of</font>
        |  	ok -&gt;
<font color=red>     0..|  	    ok;</font>
        |  	{error, Reason} -&gt;
<font color=red>     0..|  	    Error_message = io_lib:format("Could not send to server: ~p",[Reason]),</font>
<font color=red>     0..|  	    ?log(Error_message),</font>
<font color=red>     0..|  	    {error, Reason}</font>
        |      end.
</pre>
</body>
</html>
